@model ayhankizil.Models.PaylasimViewModel

@{
    ViewData["Title"] = "Prof. Dr. Ayhan Kızıl";
}

<div class="outer-box">
    <!-- Sadece üst kısımdaki profil ve metin için inner-box -->
    <div class="inner-box">
        <div class="content d-flex flex-column flex-sm-row gap-3 gap-md-4 gap-lg-5 align-items-start justify-content-center">
            <div class="image-container align-self-center align-self-sm-start">
                <img src="~/images/Prof-Dr-Ayhan-Kizil-2.jpg" alt="Ayhan Kızıl" class="photo" />
                <div class="year text-center" style="font-weight: 300; color: #666; margin-top: 8px;">(1937 - 2015)</div>
            </div>
            <div class="text text-start" style="max-width: 450px;">
                <h1 class="fs-1 fs-sm-2 fs-md-1">
                    <span class="light-bold">Prof.Dr.</span><span class="strong-bold"> Ayhan Kızıl</span>
                </h1>
                <p>Sevgili Eşim<br>Değerli Babamız<br>Biricik Dedemiz<br>Prof. Ayhan Kızıl aniden aramızdan ayrıldı.</p>
                <p>Onu zaten biz sevenleri hiç unutmayacağız.<br>Onunla olan anılarımızı bu sitede paylaşacağız ki bu güzel gülen insanı çocuklarımız da, torunlarımız da, dostlarımız da hiç unutmasınlar.</p>
                <p>İlk aşaması olan bu sitede ister anılarınızı, isterseniz onunla beraber olan fotolarınızı paylaşabilirsiniz.<br>Yakın bir zamanda bu site olması gerektiği şekilde düzenlenip, hayatına devam edecektir.</p>
                <p class="goodbye">Güle güle Ayhan Dedemiz</p>
            </div>
        </div>
    </div>

    <!-- Start WOWSlider.com BODY section -->
    <link rel="stylesheet" type="text/css" href="~/engine1/style.css" />

    <div id="wowslider-container1">
        <div class="ws_images">
            <ul>
                <li><img src="~/data1/images/1.jpg" alt="1" title="1" id="wows1_0" /></li>
            </ul>
        </div>
        
    </div>

    <script type="text/javascript" src="~/engine1/jquery.js"></script>
    <script type="text/javascript" src="~/engine1/wowslider.js"></script>
    <script type="text/javascript" src="~/engine1/script.js"></script>

    <!-- Anı Defteri Başlığı -->
    <div class="header-box text-center">
        <h2>ANI DEFTERİ</h2>
    </div>
    <br />

    <!-- Paylaşım Alanı ve Form -->
    <div class="row">
        <!-- Sol Kutu: Fotoğraf ve Açıklama -->
        <div class="col-12 col-lg-6 mb-4 sol-kutu-wrapper">
            <div class="sol-kutu text-center">
                <img src="~/images/ayhan.jpg" class="img-fluid foto" alt="foto" />
            </div>
            <p class="mt-3 sol-kutu-yazi">
                Prof.Dr. Ayhan Kızıl ile ilgili düşüncelerinizi ve fotoğraflarınızı yandaki formu kullanarak
                <strong>paylaşabilirsiniz.</strong><br /><br>
                Yanda görülen kısma isminizi ve yazınızı yazabilir; fotoğraf eklemek için yine yanda görünen
                fotoğraf ekle kısmına tıklayarak bilgisayarınızdaki resmi yükleyebilirsiniz.
            </p>
        </div>


        <!-- Sağ Form Alanı -->
        <div class="col-12 col-lg-6">
            <form asp-controller="Paylasim" asp-action="Ekle" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <div class="form-group row align-items-center mb-3">
                    <label for="ad-soyad" class="col-sm-3 col-form-label">Adı Soyadı</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="ad-soyad" name="AdSoyad" required />
                    </div>
                </div>

                <div class="form-group row align-items-center mb-3">
                    <label for="email" class="col-sm-3 col-form-label">Email</label>
                    <div class="col-sm-9">
                        <input type="email" class="form-control" id="email" name="Email" required />
                    </div>
                </div>

                <div class="form-group row mb-3">
                    <label for="paylasim" class="col-sm-3 col-form-label">Paylaşımınız</label>
                    <div class="col-sm-9">
                        <textarea class="form-control" id="paylasim" name="PaylasimMetni" rows="5" maxlength="1000" required></textarea>
                    </div>
                </div>

                <!-- Fotoğraf Yükleme -->
                <div class="form-group row mb-4">
                    <label class="col-sm-3 col-form-label"><br></label>
                    <div class="col-sm-9">
                        <div class="upload-row justify-content-between">
                            @for (int i = 1; i <= 4; i++)
                            {
                                var inputId = $"foto{i}";
                                var inputName = $"Foto{i}";
                                <div class="upload-col" style="position: relative;">
                                    <label for="@inputId" class="upload-box">
                                        <img src="~/images/kamera.jpg" alt="Foto @i" style="opacity: 0.5;" />
                                        <input type="file" id="@inputId" name="@inputName" accept="image/*" hidden onchange="handleFileSelect(event, @i)" />
                                    </label>
                                </div>
                            }
                        </div>

                        <div id="remove-last-photo" style="display:none; margin-top: 8px; font-weight: 400; cursor: pointer; color: black; user-select: none; font-size: 14px;">
                            &#10005; Resmi Kaldır
                        </div>

                        <div id="selected-count-info" style="margin-top: 8px; font-size: 14px; font-weight: 600;">
                        </div>

                        <small class="form-text text-muted mt-2 d-block">
                            (Max 5 MB dosya yükleyebilirsiniz.)
                        </small>
                    </div>
                </div>

                <!-- Kaydet Butonu -->
                <div class="form-group row mb-3">
                    <div class="col-sm-3"></div>
                    <div class="col-sm-9">
                        <button type="submit" class="btn-mor">Kaydet</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Uyarılar -->
        <div class="form-group row mb-3">
            <div class="col-sm-3"></div>
            <div class="col-sm-9">
                <div id="adUyarisi" class="alert alert-danger d-none" role="alert">
                    • Anı eklemek için isminizi giriniz.
                </div>
                <div id="mesajUyarisi" class="alert alert-danger d-none" role="alert">
                    • Anı eklemek için lütfen mesaj kısmını doldurunuz.
                </div>
            </div>
        </div>
    </div>

    <!-- Paylaşılanlar Başlığı -->
    <div class="header-box text-center">
        <h2>PAYLAŞILANLAR</h2>
    </div><br />

    <!-- Paylaşılan İçerikler (PARTIAL) -->
    @await Html.PartialAsync("_PaylasilanlarPartial", Model)

    <!-- Bootstrap Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body p-0 text-center">
                    <img id="modalImage" src="" class="img-fluid" style="max-width: 80%; max-height: 80vh;" />
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Form validasyon
    document.querySelector("form").addEventListener("submit", function (e) {
        e.preventDefault();
        const ad = document.getElementById("ad-soyad").value.trim();
        const mesaj = document.getElementById("paylasim").value.trim();
        const adUyarisi = document.getElementById("adUyarisi");
        const mesajUyarisi = document.getElementById("mesajUyarisi");
        let valid = true;
        if (ad === "") { adUyarisi.classList.remove("d-none"); valid = false; } else adUyarisi.classList.add("d-none");
        if (mesaj === "") { mesajUyarisi.classList.remove("d-none"); valid = false; } else mesajUyarisi.classList.add("d-none");
        if (valid) this.submit();
    });

    // Bootstrap modal için açma fonksiyonu
    function openModal(src) {
        const modalImage = document.getElementById("modalImage");
        modalImage.src = src;
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    }

    // Fotoğraf seçimi UI güncelleme kodları
    const selectedFiles = {};

    function handleFileSelect(event, index) {
        const input = event.target;
        const files = input.files;

        if (files.length === 0) {
            delete selectedFiles[index];
            updateUI();
            return;
        }

        const file = files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            selectedFiles[index] = {
                file: file,
                dataURL: e.target.result
            };
            updateUI();
        };
        reader.readAsDataURL(file);
    }

    function updateUI() {
        const count = Object.keys(selectedFiles).length;
        const selectedCountInfo = document.getElementById('selected-count-info');
        const removeBtn = document.getElementById('remove-last-photo');

        if (count === 0) {
            selectedCountInfo.textContent = '';
            removeBtn.style.display = 'none';
        } else if (count === 1) {
            selectedCountInfo.textContent = '1 adet fotoğraf seçildi';
            removeBtn.style.display = 'block';
        } else {
            selectedCountInfo.textContent = count + ' adet fotoğraf seçildi';
            removeBtn.style.display = 'block';
        }

        for (let i = 1; i <= 4; i++) {
            const input = document.getElementById(`foto${i}`);
            if (!input) continue;
            const uploadBoxImg = input.closest('.upload-col').querySelector('label.upload-box img');

            if (selectedFiles[i]) {
                uploadBoxImg.style.opacity = '1';
            } else {
                uploadBoxImg.style.opacity = '0.5';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateUI();

        document.getElementById('remove-last-photo').addEventListener('click', () => {
            const keys = Object.keys(selectedFiles).map(k => parseInt(k)).sort((a,b) => b - a);
            if (keys.length === 0) return;

            const lastKey = keys[0];
            const input = document.getElementById(`foto${lastKey}`);
            if (!input) return;

            input.value = '';
            delete selectedFiles[lastKey];
            updateUI();
        });
    });

    // SAYFALAMA FONKSİYONLARI - URL DEĞİŞTİRMEDEN
    function loadPage(pageNumber) {
        console.log('loadPage çağrıldı, sayfa:', pageNumber);

        const container = document.querySelector('#paylasilan-icerikler');
        container.style.opacity = '0.7';

        const currentPath = window.location.pathname;
        const fetchUrl = `${currentPath}?page=${pageNumber}`;

        fetch(fetchUrl, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'text/html'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.text();
        })
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContent = doc.querySelector('#paylasilan-icerikler');

            if (newContent) {
                document.querySelector('#paylasilan-icerikler').innerHTML = newContent.innerHTML;

                document.querySelectorAll('.pagination-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (parseInt(btn.textContent) === pageNumber) {
                        btn.classList.add('active');
                    }
                });
            }

            container.style.opacity = '1';
        })
        .catch(error => {
            console.error('Sayfa yüklenirken hata:', error);
            container.style.opacity = '1';
            alert('Sayfa yüklenirken hata oluştu: ' + error.message);
        });

        return false;
    }

    // Sayfa ilk yüklendiğinde aktif sayfa butonunu işaretle
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const currentPage = urlParams.get('page') || 1;

        document.querySelectorAll('.pagination-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent == currentPage) {
                btn.classList.add('active');
            }
        });
    });
</script>
